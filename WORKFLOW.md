# ๐ ICETEX Petition Classifier - Workflow Guide

This document explains the complete workflow of the petition classification system.

---

## ๐ System Workflow

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         START                                   โ
โ              User opens http://localhost:8000                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  STEP 1: UPLOAD INTERFACE                       โ
โ                                                                 โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ  โ  ๐ Clasificador de Peticiones ICETEX                 โ    โ
โ  โ                                                        โ    โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ    โ
โ  โ  โ  โ๏ธ  Haga clic o arrastre un archivo PDF    โ     โ    โ
โ  โ  โ     Acepta PDFs con texto o escaneados       โ     โ    โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ     โ    โ
โ  โ                                                        โ    โ
โ  โ  [Clasificar Peticiรณn]                                โ    โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ User selects/drops PDF
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  STEP 2: FILE VALIDATION                        โ
โ                                                                 โ
โ  โ Check file type (must be .pdf)                             โ
โ  โ Check file size (not empty)                                โ
โ  โ Prepare for upload                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ Validation passed
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  STEP 3: PROCESSING                             โ
โ                                                                 โ
โ  ๐ Procesando PDF y clasificando con IA...                    โ
โ     Esto puede tomar unos segundos                             โ
โ                                                                 โ
โ  Backend Process:                                               โ
โ  1. Receive PDF file                                            โ
โ  2. Save to temporary location                                  โ
โ  3. Extract text โ See "Text Extraction Flow" below            โ
โ  4. Send to OpenAI โ See "AI Classification Flow" below        โ
โ  5. Clean up temporary files                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ Processing complete
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  STEP 4: DISPLAY RESULTS                        โ
โ                                                                 โ
โ  โ Resultado de la Clasificaciรณn                              โ
โ                                                                 โ
โ  Dependencia Asignada:                                          โ
โ  โบ Vicepresidencia de Fondos en Administraciรณn                 โ
โ                                                                 โ
โ  Nivel de Confianza:                                            โ
โ  โบ 95%                                                          โ
โ                                                                 โ
โ  Justificaciรณn:                                                 โ
โ  โบ The petition requests forgiveness (condonaciรณn) of...       โ
โ                                                                 โ
โ  Palabras Clave:                                                โ
โ  โบ [condonaciรณn] [fondo] [crรฉdito educativo]                   โ
โ                                                                 โ
โ  [Clasificar Otra Peticiรณn]                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ User clicks reset
                         โผ
                    Back to STEP 1
```

---

## ๐ Text Extraction Flow

```
PDF File Received
    โ
    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Try pdfplumber (Text Extraction)   โ
โ  Fast method for digital PDFs       โ
โโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ
            โผ
    Text extracted? (>100 chars)
            โ
            โโ YES โโโโโโโโโโโโโโโโโโโโโโ
            โ                           โ
            โโ NO                       โ
                โ                       โ
                โผ                       โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโ       โ
    โ  Convert PDF to Images   โ       โ
    โ  (pdf2image + Poppler)  โ       โ
    โโโโโโโโโโโโฌโโโโโโโโโโโโโโโ       โ
               โ                       โ
               โผ                       โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโ       โ
    โ  Run OCR on each page   โ       โ
    โ  (pytesseract)          โ       โ
    โ  Language: Spanish      โ       โ
    โโโโโโโโโโโโฌโโโโโโโโโโโโโโโ       โ
               โ                       โ
               โผ                       โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโ       โ
    โ  Combine all page texts โ       โ
    โโโโโโโโโโโโฌโโโโโโโโโโโโโโโ       โ
               โ                       โ
               โโโโโโโโโโโโโโโโโโโโโโโโโค
                                       โ
                                       โผ
                            โโโโโโโโโโโโโโโโโโโโ
                            โ  Extracted Text  โ
                            โ  (Ready for AI)  โ
                            โโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ค AI Classification Flow

```
Extracted Text Received
    โ
    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Prepare OpenAI API Call                    โ
โ  - Model: gpt-4-turbo                       โ
โ  - Temperature: 0.3 (consistent results)    โ
โ  - Response format: JSON                    โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  System Prompt (Rules & Context)            โ
โ                                             โ
โ  "You are an AI classification system..."  โ
โ  + 12 classification rules                  โ
โ  + Example classifications                  โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  User Message                               โ
โ  "Classify this petition:"                  โ
โ  + Full extracted text                      โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Send to OpenAI API                         โ
โ  (Network request)                          โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Receive JSON Response                      โ
โ  {                                          โ
โ    "dependencia": "...",                    โ
โ    "confianza": "XX%",                      โ
โ    "motivo": "...",                         โ
โ    "palabras_clave": [...]                  โ
โ  }                                          โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Validate Response                          โ
โ  - Check all required fields present        โ
โ  - Validate JSON structure                  โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Add Metadata                               โ
โ  - Model used                               โ
โ  - Text length                              โ
โ  - Text preview                             โ
โ  - Original filename                        โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Return to Frontend                         โ
โ  Complete classification result             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฏ Decision Rules (AI Classification)

The AI uses these rules to classify petitions:

### Rule 1: Fondos y Condonaciรณn
**Keywords**: fondos, convenios, condonaciรณn, becas, crรฉdito condonable  
**โ Vicepresidencia de Fondos en Administraciรณn**

Example: "Solicito la condonaciรณn del crรฉdito del Fondo Bicentenario"

### Rule 2: Legal Matters
**Keywords**: demanda, sanciรณn, resoluciรณn, fallo, normatividad, derecho, apelaciรณn, abogado  
**โ Oficina Asesora Jurรญdica**

Example: "Interpongo recurso de apelaciรณn contra la resoluciรณn 123"

### Rule 3: Risk & Internal Control
**Keywords**: riesgos, cumplimiento, control interno, auditorรญa, transparencia  
**โ Oficina de Riesgos** or **Oficina de Control Interno**

Example: "Solicito auditorรญa del proceso de selecciรณn"

### Rule 4: Planning
**Keywords**: planeaciรณn, estrategia, indicadores, metas institucionales  
**โ Oficina Asesora de Planeaciรณn**

Example: "Propuesta para mejorar indicadores de gestiรณn"

### Rule 5: Technology
**Keywords**: tecnologรญa, plataforma, sistema, errores tรฉcnicos, mantenimiento  
**โ Vicepresidencia de Operaciones y Tecnologรญa**

Example: "La plataforma presenta errores al cargar documentos"

### Rule 6: Communications
**Keywords**: comunicaciรณn, prensa, medios, campaรฑas  
**โ Oficina Asesora de Comunicaciones**

Example: "Solicito nota de prensa sobre nuevo programa"

### Rule 7: Collections
**Keywords**: cobro, mora, pagos, deudas, cartera  
**โ Vicepresidencia de Crรฉdito y Cobranza**

Example: "Solicito acuerdo de pago para deuda en mora"

### Rule 8: Finance
**Keywords**: presupuesto, finanzas, tesorerรญa, contabilidad  
**โ Vicepresidencia Financiera**

Example: "Consulta sobre estado de cuenta y saldos"

### Rule 9: International
**Keywords**: internacional, becas en el exterior, cooperaciรณn  
**โ Oficina de Relaciones Internacionales**

Example: "Informaciรณn sobre becas de maestrรญa en Espaรฑa"

### Rule 10: Commercial
**Keywords**: comercial, mercadeo, usuarios, aliados estratรฉgicos  
**โ Oficina Comercial y de Mercadeo**

Example: "Propuesta de alianza estratรฉgica con universidad"

### Rule 11: HR & Records
**Keywords**: personal, contrataciรณn, archivos, secretarรญa  
**โ Secretarรญa General**

Example: "Solicito copia certificada de contrato"

### Rule 12: Ambiguous Cases
If the petition matches multiple categories or is unclear:
- AI selects the most probable dependency
- Lowers confidence level accordingly
- Provides detailed explanation

---

## ๐ Example Processing Times

### Scenario A: Digital PDF (5 pages)
```
Upload:           0.5s
Text Extraction:  1.0s (pdfplumber)
AI Classification: 2.5s
Display Results:   0.5s
โโโโโโโโโโโโโโโโโโโโโโ
TOTAL:            4.5s
```

### Scenario B: Scanned PDF (5 pages)
```
Upload:           0.5s
PDF to Images:    2.0s
OCR Processing:   8.0s (pytesseract)
AI Classification: 2.5s
Display Results:   0.5s
โโโโโโโโโโโโโโโโโโโโโโ
TOTAL:           13.5s
```

---

## ๐ User Interaction Flow

```
1. User arrives at homepage
   โโโ Sees upload interface
   
2. User uploads PDF
   โโโ Drag & drop OR
   โโโ Click to browse
   
3. File selected
   โโโ Filename displayed
   โโโ "Clasificar Peticiรณn" button enabled
   
4. User clicks "Clasificar Peticiรณn"
   โโโ Loading spinner appears
   โโโ Upload form disabled
   
5. Processing happens
   โโโ Progress message shown
   โโโ User waits (3-15 seconds)
   
6. Results displayed
   โโโ Dependency highlighted
   โโโ Confidence shown
   โโโ Explanation provided
   โโโ Keywords listed
   
7. User options:
   โโโ Review results
   โโโ Click "Clasificar Otra Peticiรณn"
       โโโ Returns to step 1
```

---

## ๐จ UI States

### State 1: Initial (Ready for Upload)
- Upload area: Visible, interactive
- Submit button: Enabled
- Results: Hidden
- Loading: Hidden
- Error: Hidden

### State 2: File Selected
- Upload area: Shows selected filename
- Submit button: Enabled, highlighted
- Results: Hidden
- Loading: Hidden
- Error: Hidden

### State 3: Processing
- Upload area: Disabled
- Submit button: Disabled
- Results: Hidden
- Loading: **Visible with spinner**
- Error: Hidden

### State 4: Success
- Upload area: Hidden
- Submit button: Hidden
- Results: **Visible with data**
- Loading: Hidden
- Error: Hidden

### State 5: Error
- Upload area: Visible
- Submit button: Enabled
- Results: Hidden
- Loading: Hidden
- Error: **Visible with message**

---

## ๐ Security Flow

```
PDF Upload Request
    โ
    โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Validate File Type     โ
โ  Must be .pdf           โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Validate File Size     โ
โ  Must not be empty      โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Save to Temp Location  โ
โ  Isolated from system   โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Process PDF            โ
โ  Extract text only      โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Delete Temp File       โ
โ  Immediate cleanup      โ
โโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Send Text to OpenAI    โ
โ  API key from .env      โ
โ  Never exposed to user  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฏ Success Criteria Checklist

For each petition classification, the system must:

- [ ] Accept the PDF file successfully
- [ ] Extract readable text (>10 characters)
- [ ] Send text to OpenAI API
- [ ] Receive valid JSON response
- [ ] Display dependency name
- [ ] Display confidence percentage
- [ ] Display natural language explanation
- [ ] Display detected keywords (if any)
- [ ] Allow user to reset and classify another
- [ ] Clean up temporary files
- [ ] Handle errors gracefully

---

## ๐ก Tips for Best Results

### For Users
1. **Use clear, well-written petitions**
2. **Ensure scanned PDFs are high quality** (300 DPI+)
3. **Include relevant keywords** in petition text
4. **Write in Spanish** (system is optimized for Spanish)

### For Administrators
1. **Monitor OpenAI API costs** at platform.openai.com
2. **Check server logs** for processing issues
3. **Test with various PDF types** regularly
4. **Update system prompt** if classification rules change

---

## ๐ Performance Optimization

### Current Performance
- Text PDF: ~4-5 seconds
- Scanned PDF: ~13-15 seconds

### Optimization Opportunities
1. **Implement caching** for repeated petitions
2. **Use async processing** for multiple uploads
3. **Add progress indicators** for long OCR processes
4. **Optimize image quality** for OCR (balance quality/speed)
5. **Consider GPT-3.5-turbo** for simpler cases

---

**Ready to classify petitions? Start the server and upload a PDF!**

```bash
./start.sh
```

Then open: http://localhost:8000

